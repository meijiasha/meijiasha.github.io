<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV 批次匯入店家</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="LOGO.svg" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        padding-top: 56px;
      }
      .container {
        max-width: 960px;
      }
      .mapping-table th,
      .mapping-table td {
        vertical-align: middle;
      }
      .preview-table-container {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="admin.html">返回店家列表</a>
      </div>
    </nav>

    <div class="container mt-4">
      <h2>CSV 批次匯入店家資料</h2>
      <hr />

      <!-- 步驟 1: 選擇檔案 -->
      <div class="mb-3 card">
        <div class="card-body">
          <h5 class="card-title">步驟 1: 選擇 CSV 檔案</h5>
          <div class="mb-3">
            <label for="csvFile" class="form-label">選擇包含店家資料的 CSV 檔案</label>
            <input class="form-control" type="file" id="csvFile" accept=".csv" />
          </div>
          <button class="btn btn-primary" id="loadCsvHeadersBtn">載入並預覽欄位</button>
          <!-- **** 新增下載範本按鈕 **** -->
          <button class="btn btn-outline-secondary" id="downloadTemplateBtn"><i class="bi bi-download"></i> 下載 CSV 範本</button>
        </div>
      </div>

      <!-- 步驟 2: 欄位對應 -->
      <div id="fieldMappingSection" class="mb-3 card" style="display: none">
        <div class="card-body">
          <h5 class="card-title">步驟 2: 欄位對應</h5>
          <p class="card-text">請將 CSV 檔案中的欄位對應到 Firestore 資料庫的目標欄位。</p>
          <div class="alert alert-info small">
            <strong>提示：</strong>
            <ul>
              <li>「店家名稱」、「行政區」、「分類」為建議必填。</li>
              <li>「緯度」和「經度」必須同時提供有效的數字，或都留空。</li>
              <li>如果 CSV 中沒有對應的欄位，可以選擇「-- 不匯入此欄位 --」。</li>
            </ul>
          </div>
          <table class="table mapping-table">
            <thead>
              <tr>
                <th>Firestore 目標欄位</th>
                <th>對應的 CSV 欄位</th>
              </tr>
            </thead>
            <tbody id="mappingTableBody">
              <!-- 欄位對應選項將由 JS 填入 -->
            </tbody>
          </table>
          <button class="btn btn-success" id="processImportBtn" disabled>開始匯入資料</button>
        </div>
      </div>

      <!-- 步驟 3: 匯入狀態與結果 -->
      <div id="importStatusSection" class="mb-3 card" style="display: none">
        <div class="card-body">
          <h5 class="card-title">步驟 3: 匯入狀態</h5>
          <div id="importProgress" class="progress mb-2" style="display: none">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div id="importLog" class="alert alert-light" style="max-height: 200px; overflow-y: auto">等待開始匯入...<br /></div>
          <button class="btn btn-secondary mt-2" id="backToListBtn" onclick="window.location.href='admin.html'" style="display: none">返回店家列表</button>
        </div>
      </div>
    </div>
    <!-- 在 <body> 的末尾，所有主要內容之後，<script> 標籤之前 -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <!-- Toasts 將會被 JavaScript 動態插入到這裡 -->
      <!-- 可以預先放一個範例 Toast 結構來測試樣式，但 JS 會動態創建 -->
      <!--
    <div id="liveToastExample" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false"><rect width="100%" height="100%" fill="#007aff"></rect></svg>
            <strong class="me-auto">通知</strong>
            <small>剛剛</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            這是一條 Toast 訊息。
        </div>
    </div>
    --></div>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js?version=1"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js?version=1"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js?version=1"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions-compat.js?version=1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- PapaParse -->
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyA4sQav5EeZowQKRya14xeG9Lj3TyMQdM4",
        authDomain: "meijiasha-64de6.firebaseapp.com",
        projectId: "meijiasha-64de6",
        storageBucket: "meijiasha-64de6.firebasestorage.app",
        messagingSenderId: "732275424686",
        appId: "1:732275424686:web:9e1349c421503f75da5c3f",
        measurementId: "G-07JZNDTJN7",
        // ... 您的 Firebase 設定 ...
      };
      try {
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        var auth = firebase.auth();
        console.log("CSV 匯入頁面 HTML: Firebase Initialized.");
      } catch (error) {
        /* ... */
      }
    </script>
    <script src="import-csv-script.js"></script>
  </body>
</html>
