<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地址轉換經緯度工具</title>
    <link rel="shortcut icon" href="LOGO.svg" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; padding-bottom: 20px; }
        .container { max-width: 720px; }
        #mapPreview {
            height: 300px;
            width: 100%;
            background-color: #e9e9e9;
            margin-top: 1rem;
            border: 1px solid #ccc;
        }
        .result-item { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">地址轉換經緯度</h1>

        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label for="addressInput" class="form-label">輸入地址：</label>
                    <input type="text" class="form-control" id="addressInput" placeholder="例如：台北市信義區市府路1號">
                </div>
                <button class="btn btn-primary" id="geocodeButton" disabled> <span id="buttonText">轉換經緯度</span> </button>

                <div id="loadingIndicator" class="mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">處理中...</span>
                    </div>
                    <span id="loadingText">處理中...</span>
                </div>

                <div id="resultsContainer" class="mt-4" style="display: none;">
                    <h4>轉換結果：</h4>
                    <div class="result-item">
                        <strong>原始地址:</strong> <span id="resultOriginalAddress"></span>
                    </div>
                    <div class="result-item">
                        <strong>格式化地址:</strong> <span id="resultFormattedAddress"></span>
                    </div>
                    <div class="result-item">
                        <strong>緯度 (Latitude):</strong> <span id="resultLat" class="fw-bold"></span>
                    </div>
                    <div class="result-item">
                        <strong>經度 (Longitude):</strong> <span id="resultLng" class="fw-bold"></span>
                    </div>
                    <div class="result-item">
                        <strong>Place ID:</strong> <span id="resultPlaceId"></span>
                    </div>
                    <div id="mapPreview" style="display: none;"></div> <!-- 初始隱藏，有結果再顯示 -->
                </div>
                <div id="errorContainer" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Google Maps API 腳本 (使用您的金鑰) -->
    <script>
        // 將 API Key 移到這裡，方便管理
        const GOOGLE_MAPS_API_KEY = "AIzaSyCtd5KFPQASnh_nOmkACetkvgkyATSWEuw"; // 請再次確認這是您正確且已啟用的金鑰

        function loadGoogleMapsApi() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=geocoding,marker&callback=initGeocodePage&language=zh-TW&region=TW&loading=async&defer=true`;
            script.onerror = () => {
                console.error("Google Maps API script failed to load. Check network or API key validity.");
                const errorContainer = document.getElementById('errorContainer');
                const geocodeButton = document.getElementById('geocodeButton');
                if (errorContainer) {
                    errorContainer.textContent = "地圖服務載入失敗，請檢查您的網路連線或 API 金鑰設定。頁面功能可能無法使用。";
                    errorContainer.style.display = 'block';
                }
                if (geocodeButton) geocodeButton.disabled = true; // 禁用按鈕
            };
            document.head.appendChild(script);
        }
        // 在 window load 事件後加載 Google Maps API，確保頁面基本結構已準備好
        window.addEventListener('load', loadGoogleMapsApi);
    </script>

    <script>
        let map;
        let geocoder;
        let currentMarker = null; // 用於追蹤當前地圖上的標記

        // DOM 元素 (在 initGeocodePage 中獲取)
        let addressInput, geocodeButton, buttonText, loadingIndicator, loadingText,
            resultsContainer, errorContainer,
            resultOriginalAddress, resultFormattedAddress, resultLat, resultLng, resultPlaceId,
            mapPreviewDiv;

        // API 載入後執行的初始化函數
        function initGeocodePage() {
            console.log("initGeocodePage CALLED: Google Maps API should be loaded.");

            // 再次檢查 google.maps 是否真的可用
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("initGeocodePage: google.maps object is not available. API might not have loaded correctly.");
                const errorContainer = document.getElementById('errorContainer');
                if (errorContainer) {
                    errorContainer.textContent = "地圖核心服務初始化失敗。請刷新頁面或檢查主控台。";
                    errorContainer.style.display = 'block';
                }
                // 禁用按鈕
                const geocodeBtn = document.getElementById('geocodeButton');
                if (geocodeBtn) geocodeBtn.disabled = true;
                return;
            }

            try {
                geocoder = new google.maps.Geocoder();
                console.log("Geocoder initialized.");
            } catch (e) {
                console.error("Error initializing Geocoder:", e);
                const errorContainer = document.getElementById('errorContainer');
                if (errorContainer) {
                    errorContainer.textContent = "地理編碼服務初始化失敗。";
                    errorContainer.style.display = 'block';
                }
                const geocodeBtn = document.getElementById('geocodeButton');
                if (geocodeBtn) geocodeBtn.disabled = true;
                return;
            }


            // 獲取 DOM 元素
            addressInput = document.getElementById('addressInput');
            geocodeButton = document.getElementById('geocodeButton');
            buttonText = document.getElementById('buttonText');
            loadingIndicator = document.getElementById('loadingIndicator');
            loadingText = document.getElementById('loadingText'); // 如果您想改變處理中文字
            resultsContainer = document.getElementById('resultsContainer');
            errorContainer = document.getElementById('errorContainer');
            resultOriginalAddress = document.getElementById('resultOriginalAddress');
            resultFormattedAddress = document.getElementById('resultFormattedAddress');
            resultLat = document.getElementById('resultLat');
            resultLng = document.getElementById('resultLng');
            resultPlaceId = document.getElementById('resultPlaceId');
            mapPreviewDiv = document.getElementById('mapPreview');

            if (!addressInput || !geocodeButton || !resultsContainer || !errorContainer || !mapPreviewDiv) {
                console.error("initGeocodePage: One or more critical DOM elements not found.");
                if (errorContainer) {
                    errorContainer.textContent = "頁面結構不完整，部分功能可能無法使用。";
                    errorContainer.style.display = 'block';
                }
                if (geocodeButton) geocodeButton.disabled = true;
                return;
            }

            // 初始化地圖 (確保 mapPreviewDiv 存在)
            try {
                map = new google.maps.Map(mapPreviewDiv, {
                    center: { lat: 25.0330, lng: 121.5654 }, // 預設中心點
                    zoom: 12,
                    disableDefaultUI: true,
                    zoomControl: true,
                });
                console.log("Map initialized.");
            } catch (e) {
                console.error("Error initializing Map:", e);
                if (errorContainer) {
                    errorContainer.textContent = "地圖預覽初始化失敗。";
                    errorContainer.style.display = 'block';
                }
                // 轉換功能仍然可以嘗試，但地圖預覽會失敗
            }


            // 啟用按鈕並綁定事件
            geocodeButton.disabled = false; // 啟用轉換按鈕
            geocodeButton.addEventListener('click', () => {
                performGeocode(addressInput.value);
            });
            addressInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    performGeocode(addressInput.value);
                }
            });
            console.log("Event listeners attached to geocode button and address input.");
        }

        // 執行地理編碼轉換
        async function performGeocode(address) { // 改為 async 以便使用 await for AdvancedMarkerElement
            console.log("performGeocode CALLED with address:", address);
            if (!geocoder) {
                console.error("performGeocode: Geocoder not initialized.");
                if (errorContainer) { errorContainer.textContent = "地理編碼服務未就緒。"; errorContainer.style.display = 'block'; }
                return;
            }
            if (!address || address.trim() === "") {
                if (errorContainer) { errorContainer.textContent = "請輸入有效的地址。"; errorContainer.style.display = 'block'; }
                if (resultsContainer) resultsContainer.style.display = 'none';
                if (mapPreviewDiv) mapPreviewDiv.style.display = 'none';
                return;
            }

            // 更新UI：顯示處理中，隱藏舊結果/錯誤
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (buttonText && geocodeButton) { geocodeButton.disabled = true; buttonText.textContent = "轉換中...";}
            if (resultsContainer) resultsContainer.style.display = 'none';
            if (errorContainer) errorContainer.style.display = 'none';
            if (mapPreviewDiv) mapPreviewDiv.style.display = 'none';


            console.log("Calling geocoder.geocode for address:", address);
            geocoder.geocode({ 'address': address, 'region': 'TW' }, async (results, status) => { // 回呼改為 async
                console.log("Geocoder.geocode CALLBACK received. Status:", status, "Results:", results);

                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (buttonText && geocodeButton) { geocodeButton.disabled = false; buttonText.textContent = "轉換經緯度";}


                if (status === google.maps.places.PlacesServiceStatus.OK) { // 使用正確的狀態常量
                    if (results && results[0]) {
                        const location = results[0].geometry.location;
                        const lat = location.lat();
                        const lng = location.lng();

                        console.log("Geocode successful. Lat:", lat, "Lng:", lng, "Formatted:", results[0].formatted_address);

                        if (resultOriginalAddress) resultOriginalAddress.textContent = address;
                        if (resultFormattedAddress) resultFormattedAddress.textContent = results[0].formatted_address;
                        if (resultLat) resultLat.textContent = lat.toFixed(6);
                        if (resultLng) resultLng.textContent = lng.toFixed(6);
                        if (resultPlaceId) resultPlaceId.textContent = results[0].place_id || 'N/A';

                        if (resultsContainer) resultsContainer.style.display = 'block';

                        if (map && mapPreviewDiv) {
                            mapPreviewDiv.style.display = 'block'; // 顯示地圖容器
                            map.setCenter(location);
                            map.setZoom(17);
                            if (currentMarker) {
                                currentMarker.map = null; // 移除舊標記
                            }
                            try {
                                // 載入 AdvancedMarkerElement
                                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                                currentMarker = new AdvancedMarkerElement({
                                    map: map,
                                    position: location,
                                    title: results[0].formatted_address
                                });
                                console.log("Marker placed on map.");
                            } catch (markerError) {
                                console.error("Error creating AdvancedMarkerElement:", markerError);
                                if (errorContainer) { errorContainer.textContent = "地圖標記創建失敗。"; errorContainer.style.display = 'block';}
                            }
                        } else {
                            console.warn("Map or mapPreviewDiv not available for marker placement.");
                        }
                    } else {
                        console.warn("Geocode status OK, but no results array or first result is missing.");
                        if (errorContainer) { errorContainer.textContent = "找不到座標，但API狀態正常。請嘗試更明確的地址。"; errorContainer.style.display = 'block';}
                    }
                } else {
                    console.error("Geocode failed. Status:", status);
                    let userMessage = "地址轉換失敗。";
                    switch (status) {
                        case google.maps.places.PlacesServiceStatus.ZERO_RESULTS: // 使用正確的狀態常量
                            userMessage = "找不到該地址的座標，請確認地址是否正確。";
                            break;
                        case google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT:
                            userMessage = "已超出查詢配額，請稍後再試。";
                            break;
                        case google.maps.places.PlacesServiceStatus.REQUEST_DENIED:
                            userMessage = "請求被拒絕，可能是 API 金鑰問題或 Geocoding API 未啟用。";
                            break;
                        case google.maps.places.PlacesServiceStatus.INVALID_REQUEST:
                            userMessage = "請求無效，請檢查輸入的地址是否為空或格式錯誤。";
                            break;
                        case google.maps.places.PlacesServiceStatus.UNKNOWN_ERROR:
                            userMessage = "發生未知的伺服器錯誤，請稍後再試。";
                            break;
                        default:
                            userMessage = `地址轉換失敗，錯誤狀態：${status}`;
                    }
                    if (errorContainer) { errorContainer.textContent = userMessage; errorContainer.style.display = 'block';}
                }
            });
        }
    </script>
</body>
</html>