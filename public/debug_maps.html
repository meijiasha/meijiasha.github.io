    <style>
        body { font-family: sans-serif; padding: 20px; }
        .result-box { border: 1px solid #ccc; padding: 15px; margin-top: 15px; border-radius: 5px; }
        .component-item { margin-left: 20px; color: #555; }
        .highlight { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
    <script>
        const CITIES = {
            Taipei: "台北市",
            NewTaipei: "新北市",
            Taichung: "台中市",
            Kaohsiung: "高雄市",
        };
        const DISTRICTS = {
            "台北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
            "新北市": ["板橋區", "三重區", "中和區", "永和區", "新莊區", "新店區", "土城區", "蘆洲區", "樹林區", "汐止區", "鶯歌區", "三峽區", "淡水區", "瑞芳區", "五股區", "泰山區", "林口區", "深坑區", "石碇區", "坪林區", "三芝區", "石門區", "八里區", "平溪區", "雙溪區", "貢寮區", "金山區", "萬里區", "烏來區"],
            "台中市": ["中區", "東區", "南區", "西區", "北區", "北屯區", "西屯區", "南屯區", "太平區", "大里區", "霧峰區", "烏日區", "豐原區", "后里區", "石岡區", "東勢區", "和平區", "新社區", "潭子區", "大雅區", "神岡區", "大肚區", "沙鹿區", "龍井區", "梧棲區", "清水區", "大甲區", "外埔區", "大安區"],
            "高雄市": ["鹽埕區", "鼓山區", "左營區", "楠梓區", "三民區", "新興區", "前金區", "苓雅區", "前鎮區", "旗津區", "小港區", "鳳山區", "林園區", "大寮區", "大樹區", "大社區", "仁武區", "鳥松區", "岡山區", "橋頭區", "燕巢區", "田寮區", "阿蓮區", "路竹區", "湖內區", "茄萣區", "永安區", "彌陀區", "梓官區", "旗山區", "美濃區", "六龜區", "甲仙區", "杉林區", "內門區", "茂林區", "桃源區", "那瑪夏區"]
        };

        let map;
        let service;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 25.0330, lng: 121.5654 },
                zoom: 12,
            });
            service = new google.maps.places.PlacesService(map);
            log("Map initialized. Ready to search.");
        }

        function runSearch() {
            const input = document.getElementById("queryInput").value;
            if (!input) {
                alert("Please enter a query");
                return;
            }

            document.getElementById("log").innerHTML = "Searching for: " + input + "...<br>";
            
            // Check if input looks like a URL with Place ID
            const placeIdMatch = input.match(/(?:placeid\/|!1s)([^&/?!]+)/);
            const nameMatch = input.match(/google\.com\/maps\/place\/([^/]+)/);
            
            let query = input;
            if (nameMatch && nameMatch[1]) {
                query = decodeURIComponent(nameMatch[1].replace(/\+/g, ' '));
                log("Extracted Name from URL: " + query);
            }

            if (placeIdMatch && placeIdMatch[1] && !placeIdMatch[1].includes(':')) {
                const placeId = placeIdMatch[1];
                log("Extracted Place ID from URL: " + placeId);
                getDetails(placeId);
            } else {
                // Fallback to Text Search
                textSearch(query);
            }
        }

        function textSearch(query) {
            const request = {
                query: query
            };
            service.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    const place = results[0];
                    log("TextSearch found place: " + place.name + " (" + place.place_id + ")");
                    getDetails(place.place_id);
                } else {
                    log("<span class='highlight'>TextSearch failed: " + status + "</span>");
                }
            });
        }

        function getDetails(placeId) {
            service.getDetails({ 
                placeId: placeId, 
                fields: ['name', 'formatted_address', 'place_id', 'geometry', 'address_components'] 
            }, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    processPlace(place);
                } else {
                    log("<span class='highlight'>getDetails failed: " + status + "</span>");
                }
            });
        }

        function processPlace(place) {
            let html = "<div class='result-box'>";
            html += "<h3>" + place.name + "</h3>";
            html += "<p><strong>Address:</strong> " + place.formatted_address + "</p>";
            html += "<p><strong>Place ID:</strong> " + place.place_id + "</p>";
            
            html += "<h4>Address Components:</h4>";
            
            let foundCity = false;
            let detectedCity = "";
            let detectedDistrict = "";
            
            let locality = "";
            let sublocality = "";
            let adminArea1 = "";
            let adminArea2 = "";

            if (place.address_components) {
                place.address_components.forEach(comp => {
                    html += `<div class='component-item'>
                        [${comp.types.join(", ")}]: <strong>${comp.long_name}</strong>
                    </div>`;
                    
                    const types = comp.types;
                    const value = comp.long_name;
                    
                    if (types.includes("administrative_area_level_1")) {
                        adminArea1 = value;
                        for (const cityValue of Object.values(CITIES)) {
                            if (value.includes(cityValue) || cityValue.includes(value)) {
                                detectedCity = cityValue;
                                foundCity = true;
                            }
                        }
                    }
                    if (types.includes("administrative_area_level_2")) adminArea2 = value;
                    if (types.includes("locality")) locality = value;
                    if (types.includes("sublocality_level_1")) sublocality = value;
                });
            }

            html += "<h4>Detection Logic:</h4>";
            html += `<ul>
                <li>Admin Area 1 (City candidate): ${adminArea1}</li>
                <li>Locality (District candidate 1): ${locality}</li>
                <li>Sublocality (District candidate 2): ${sublocality}</li>
                <li>Admin Area 2: ${adminArea2}</li>
            </ul>`;

            html += "<p><strong>Matched City:</strong> " + (detectedCity || "<span class='highlight'>None</span>") + "</p>";

            if (foundCity) {
                const cityDistricts = DISTRICTS[detectedCity];
                if (locality && cityDistricts.includes(locality)) {
                    detectedDistrict = locality;
                    html += "<p class='success'>Matched District (via Locality): " + locality + "</p>";
                } else if (sublocality && cityDistricts.includes(sublocality)) {
                    detectedDistrict = sublocality;
                    html += "<p class='success'>Matched District (via Sublocality): " + sublocality + "</p>";
                } else {
                    // Fallback check
                    let fallbackFound = false;
                     for (const component of place.address_components) {
                         const val = component.long_name;
                         if (cityDistricts.includes(val)) {
                             detectedDistrict = val;
                             html += "<p class='success'>Matched District (via Component Scan): " + val + "</p>";
                             fallbackFound = true;
                             break;
                         }
                     }
                     if (!fallbackFound) {
                         html += "<p class='highlight'>Failed to match any district in " + detectedCity + "</p>";
                     }
                }
            } else {
                html += "<p class='highlight'>City not found, skipping district detection.</p>";
            }
            
            html += "</div>";
            document.getElementById("log").innerHTML += html;
        }

        function log(msg) {
            document.getElementById("log").innerHTML += msg + "<br>";
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSQZ7B7N4HHTWx_EDC72v9-1rmV1K1srk&libraries=places&language=zh-TW&region=TW&callback=initMap" async defer></script>
</head>
<body>
    <h2>Google Maps API Debugger</h2>
    <div>
        <input type="text" id="queryInput" placeholder="Enter Name, Address, or Google Maps URL" style="width: 400px; padding: 5px;">
        <button onclick="runSearch()" style="padding: 5px 10px;">Search</button>
    </div>
    <div id="map" style="height: 0px;"></div>
    <div id="log" style="margin-top: 20px;"></div>
</body>
</html>
